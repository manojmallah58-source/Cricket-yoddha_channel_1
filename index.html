<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <meta name="referrer" content="no-referrer"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  <!-- HLS.js library for M3U8 support -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      background-color: #000;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    html, body {
      height: 100%;
      width: 100%;
    }

    /* Loading spinner */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 15px;
      font-size: 20px;
      color: white;
      font-family: Arial, sans-serif;
      opacity: 0.8;
    }

    .video-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .plyr {
      height: 100%;
      width: 100%;
    }

    video::cue {
      opacity: 0;
    }

    .caption_text {
      position: absolute;
      left: 50%;
      bottom: 10%;
      width: 90%;
      max-width: 90%;
      transform: translate(-50%, -50%);
      text-align: center;
      user-select: none;
      transition: bottom 0.3s;
    }

    .caption_text.active {
      bottom: 0%;
    }

    .caption_text mark {
      background-color: #0000008f !important;
      color: #fff;
    }

    .material-icons {
      user-select: none;
      -webkit-user-select: none;
      cursor: pointer;
    }

    /* Video player Styling */
    .video_player {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    .video_player .loader{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: 60px;
      height: 60px;
      border: 4px solid #fff;
      border-bottom-color: transparent;
      border-radius: 50%;
      z-index: 1;
      animation: animate 0.6s linear infinite;
      display: none;
    }
    @keyframes animate{
      0%{
        transform: translate(-50%,-50%) rotate(0deg);
      }
      100%{
        transform: translate(-50%,-50%) rotate(360deg);
      }
    }
    .video_player .thumbnail{
      position: absolute;
      bottom: 80px;
      left: calc(var(--x) + 11px);
      transform: translateX(-50%);
      width: 165px;
      height: 90px;
      background: #fff;
      border: 2px solid #fff;
      border-radius: 3px;
      display: none;
    }
    .video_player .main-video {
      position: relative;
      width: 100%;
      height: 100%;
      outline: none;
    }

    .video_player .progressAreaTime {
      position: absolute;
      left: calc(var(--x) + 11px);
      transform: translateX(-50%);
      bottom: 50px;
      min-width: 60px;
      text-align: center;
      white-space: nowrap;
      padding: 5px 10px;
      color: #fff;
      font-size: 14px;
      font-weight: 400;
      z-index: 1;
      display: none;
    }

    .video_player .controls {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 50px;
      width: 100%;
      background: rgb(0 0 0 / 29%);
      box-shadow: 0 0 40px 10px rgb(0 0 0 / 25%);
      z-index: 3;
      transform: translateY(180%);
      transition: 0.3s;
      padding: 0px 10px;
    }

    .video_player .controls.active {
      transform: translateY(0);
    }

    .video_player .controls .progress-area {
      width: 100%;
      height: 5px;
      margin: auto;
      background: #f0f0f063;
      cursor: pointer;
      position: relative;
    }

    .video_player .controls .progress-area .progress-bar {
      position: relative;
      width: 0%;
      background: rgb(255, 174, 0);
      height: inherit;
      border-radius: inherit;
      cursor: pointer;
    }

    .video_player .controls .progress-area .progress-bar::before {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      right: -5px;
      top: 50%;
      transform: translateY(-50%);
      background: rgb(255, 174, 0);
    }
/* Frame Capture Styles */
.video_player .captured-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 300px;
  height: auto;
  max-height: 200px;
  border: 3px solid #fff;
  border-radius: 8px;
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.8);
  z-index: 1000;
  display: none;
  background: #000;
  padding: 5px;
}

.video_player .captured-frame.active {
  display: block;
}

.video_player .captured-frame img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 5px;
}

.video_player .captured-frame .close-frame {
  position: absolute;
  top: -12px;
  right: -12px;
  width: 25px;
  height: 25px;
  background: #ff0000;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  color: white;
  border: 2px solid white;
  z-index: 1001;
}

.video_player .icon .material-icons.frame-capture {
  font-size: 24px;
}
    .video_player .controls .progress-area .bufferedBar{
      position: absolute;
      top: 0%;
      right: 0%;
      width: 100%;
      height: inherit;
    }

    .video_player .controls .controls-list {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;
      width: 97%;
      height: 46px;
      margin: 0 auto;
    }

    .video_player .controls .controls-list .controls-left,
    .video_player .controls .controls-list .controls-right {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .video_player .controls .controls-left .timer {
      display: inline-block;
      font-size: 14px;
      white-space: nowrap;
      color: #fff;
      margin-left: 5px;
      text-align: center;
    }

    .video_player .controls .icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #fff;
      margin-left: 8px;
      margin-right: 5px;
    }

    .video_player .controls .icon .material-icons {
      font-size: 26px;
      color: #fff;
      cursor: pointer;
    }

    .video_player .controls .icon .material-icons.fast-rewind:active {
      transition: 0.2s;
      transform: rotate(-45deg);
    }

    .video_player .controls .icon .material-icons.fast-forward:active {
      transition: 0.2s;
      transform: rotate(45deg);
    }

    .video_player .controls .icon .volume_range {
      -webkit-appearance: none;
      appearance: none;
      width: 0px;
      height: 3px;
      background: #fff;
      color: #fff;
      cursor: pointer;
      outline: none;
      border: none;
      transition: 0.4s;
    }

    .video_player .controls .icon .volume_range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      outline: none;
      background: #fff;
      color: #fff;
      opacity: 0;
      transition: 0.3s;
    }

    .video_player .controls .icon:hover .volume_range {
      display: inline-block;
      width: 60px;
    }

    .video_player .controls .icon:hover .volume_range::-webkit-slider-thumb {
      opacity: 1;
      pointer-events: auto;
      transition: 0.5s;
    }

    .video_player .controls-right .icon .auto-play {
      width: 30px;
      height: 10px;
      border-radius: 20px;
      position: relative;
      margin-right: 8px !important;
      background: #b6b6b6;
    }

    .video_player .controls-right .icon .auto-play::before {
      content: "\e034";
      position: absolute;
      left: -5px;
      top: 50%;
      transform: translateY(-50%);
      width: 17px;
      height: 17px;
      line-height: 17px;
      font-size: 14px;
      background: #727272;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border-radius: 50%;
      font-family: "Material Icons";
    }

    .video_player .controls-right .icon .auto-play.active::before {
      content: "\e037";
      left: 15px;
      font-family: "Material Icons";
    }

    .video_player .controls-right .icon .material-icons.settingsBtn {
      font-size: 24px;
      transition: 0.3s;
    }

    .video_player .controls-right .icon .settingsBtn.active {
      transform: rotate(45deg);
    }
     
    .video_player .captions,
    .video_player .settings {
      position: absolute;
      right: 25px;
      bottom: 62px;
      background: rgb(28 28 28 / 90%);
      width: 200px;
      max-height: 250px;
      height: auto;
      color: #fff;
      overflow-y: auto;
      z-index: 20;
      display: none;
      border-radius: 5px;
    }
     
    .video_player .captions.active,
    .video_player .settings.active {
      display: block;
    }
     
    .video_player .captions .caption span,
    .video_player .settings > div > span {
      font-size: 14px;
      font-weight: 300;
      padding: 15px 30px;
      border-bottom: 1px solid rgb(83, 83, 83);
      display: flex;
      justify-content: space-between;
      align-items: center;
      white-space: nowrap;
    }
    .video_player .settings > div .icon{
      font-size: 14px;
      margin: 0 5px;
      cursor: pointer;
    }
    .video_player .settings > div ul li span{
     pointer-events: none;
    }

    .video_player .captions .caption ul,
    .video_player .settings > div ul {
      position: relative;
    }

    .video_player .captions .caption ul li,
    .video_player .settings > div ul li {
      position: relative;
      width: 100%;
      cursor: pointer;
      text-align: left;
      padding: 12px 33px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

     .video_player .captions .caption ul li:hover,
     .video_player .settings > div ul li:hover {
      background: rgba(28, 28, 28, 0.9);
    }

    .video_player .captions .caption ul li.active::before,
    .video_player .settings > div ul li.active::before {
      content: "\e876";
      font-family: "Material Icons";
      position: absolute;
      left: 7px;
      top: 50%;
      transform: translateY(-50%);
      padding-right: 10px;
      font-size: 18px;
    }

    .video_player .captions::-webkit-scrollbar,
    .video_player .settings::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }

    .video_player .captions::-webkit-scrollbar-thumb,
    .video_player .settings::-webkit-scrollbar-thumb {
      height: 20px;
      border: 2px solid transparent;
      background: rgba(83, 83, 83, 0.9);
      border-radius: 20px;
    }

    @media (max-width: 430px) {
      .video_player .controls .icon {
        margin-left: 5px;
        margin-right: 5px;
        font-size: 24px;
      }

      .volume,
      .volume_range,
      .auto-play,
      .fast-forward,
      .picture_in_picutre {
        display: none;
      }
    }
  </style>
  <title>Video Player</title>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
    <div class="spinner"></div>
    <div class="loading-text">Loading Stream…</div>
</div>

  <div class="video-container">
    <div class="video_player">
      <video preload="metadata" class="main-video" crossorigin="anonymous">
        <!-- Fallback sources -->
        <source src="How to add twak.to chat app in website-480p.mp4" size="480" type="video/mp4">
        <source src="How to add twak.to chat app in website-720p.mp4" size="720" type="video/mp4">
        <source src="How to add twak.to chat app in website-1080p.mp4" size="1080" type="video/mp4">
        <track label="English" kind="subtitles" src="./How To Get Started With VSCode.vtt" srclang="en">
        <track label="Urdu" kind="subtitles" src="./test.vtt" srclang="en">
      </video>
      <div class="loader"></div>
      <p class="caption_text"></p>
      <div class="progressAreaTime">0:00</div>
      
      <div class="controls">
        <div class="progress-area">
          <canvas class="bufferedBar"></canvas>
          <div class="progress-bar">
            <span></span>
          </div>
        </div>

        <div class="controls-list">
          <div class="controls-left">
            <span class="icon">
              <i class="material-icons fast-rewind">replay_10</i>
            </span>

            <span class="icon">
              <i class="material-icons play_pause">play_arrow</i>
            </span>

            <span class="icon">
              <i class="material-icons fast-forward">forward_10</i>
            </span>

            <span class="icon">
              <i class="material-icons volume">volume_up</i>
              <input type="range" min="0" max="100" class="volume_range" />
            </span>

            <div class="timer">
              <span class="current">0:00</span> /
              <span class="duration">0:00</span>
            </div>
          </div>

          <div class="controls-right">
            <span class="icon">
              <i class="material-icons auto-play"></i>
            </span>
<span class="icon">
  <i class="material-icons frame-capture" title="Capture Frame">photo_camera</i>
</span>
            <span class="icon">
              <i class="material-icons captionsBtn">closed_caption</i>
            </span>

            <span class="icon">
              <i class="material-icons settingsBtn">settings</i>
            </span>

            <span class="icon">
              <i class="material-icons picture_in_picutre">picture_in_picture_alt</i>
            </span>

            <span class="icon">
              <i class="material-icons fullscreen">fullscreen</i>
            </span>
          </div>
        </div>
      </div>

      <div class="settings">
        <div data-label="settingHome">
          <ul>
            <li data-label="speed">
              <span> Speed </span>
              <span class="material-symbols-outlined icon">
                arrow_forward_ios
              </span>
            </li>
            <li data-label="quality">
              <span> Quality </span>
             <span class="material-symbols-outlined icon">
              arrow_forward_ios
            </span>
            </li>
          </ul>
        </div>
        <div class="playback" data-label="speed" hidden>
          <span>
            <i class="material-symbols-outlined icon back_arrow" data-label="settingHome">
              arrow_back
            </i>
            <span>Playback Speed </span>
          </span>
          <ul>
            <li data-speed="0.25">0.25</li>
            <li data-speed="0.5">0.5</li>
            <li data-speed="0.75">0.75</li>
            <li data-speed="1" class="active">Normal</li>
            <li data-speed="1.25">1.25</li>
            <li data-speed="1.5">1.5</li>
            <li data-speed="1.75">1.75</li>
            <li data-speed="2">2</li>
          </ul>
        </div>
        <div data-label="quality" hidden>
          <span>
            <i class="material-symbols-outlined icon back_arrow" data-label="settingHome">
              arrow_back
            </i>
            <span>Playback Quality </span>
          </span>
          <ul>
            <li data-quality="auto" class="active">auto</li>
          </ul>
        </div>
      </div>
      <div class="captions">
        <div class="caption">
          <span>Select Subtitle</span>
          <ul></ul>
        </div>
      </div>
<div class="captured-frame">
  <div class="close-frame">×</div>
  <img src="" alt="Captured Frame">
</div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const video_player = document.querySelector(".video_player");
      const mainVideo = video_player.querySelector(".main-video");
      const progressAreaTime = video_player.querySelector(".progressAreaTime");
      const controls = video_player.querySelector(".controls");
      const progressArea = video_player.querySelector(".progress-area");
      const bufferedBar = video_player.querySelector(".bufferedBar");
      const progress_Bar = video_player.querySelector(".progress-bar");
      const fast_rewind = video_player.querySelector(".fast-rewind");
      const play_pause = video_player.querySelector(".play_pause");
      const fast_forward = video_player.querySelector(".fast-forward");
      const volume = video_player.querySelector(".volume");
      const volume_range = video_player.querySelector(".volume_range");
      const current = video_player.querySelector(".current");
      const totalDuration = video_player.querySelector(".duration");
      const auto_play = video_player.querySelector(".auto-play");
      const settingsBtn = video_player.querySelector(".settingsBtn");
      const captionsBtn = video_player.querySelector(".captionsBtn");
      const picture_in_picutre = video_player.querySelector(".picture_in_picutre");
      const fullscreen = video_player.querySelector(".fullscreen");
      const settings = video_player.querySelector(".settings");
      const settingHome = video_player.querySelectorAll(".settings [data-label='settingHome'] > ul > li");
      const captions = video_player.querySelector(".captions");
      const caption_labels = video_player.querySelector(".captions ul");
      const playback = video_player.querySelectorAll(".playback li");
      const tracks = video_player.querySelectorAll("track");
      const loader = video_player.querySelector(".loader");
      const caption_text = video_player.querySelector(".caption_text");
      const loadingScreen = document.getElementById("loadingScreen");

      // Get URL parameter for M3U8 stream
      const urlParams = new URLSearchParams(window.location.search);
      const USER = urlParams.get("id");
      const videoUrl = urlParams.get('url');
      
      const PROXY = "https://sony-liv-proxyb.wasmer.app/stream_proxy.php?url=";
      
      // Global hls variable
      let hls = null;

      // Function to hide loading screen
      function hideLoading() {
        loadingScreen.style.display = "none";
        loader.style.display = "none";
        controls.classList.add("active");
      }

      // Function to show error
      function showError(message) {
        hideLoading();
        document.querySelector(".video-container").innerHTML = 
          `<h2 style='color:white;text-align:center;margin-top:40vh;opacity:0.7;'>${message}</h2>`;
      }

      // Function to initialize HLS
      function initializeHLS(sourceUrl) {
        if (Hls.isSupported()) {
          hls = new Hls({
            enableWorker: false,
            lowLatencyMode: true,
            backBufferLength: 90,
            xhrSetup: function (xhr) {
              // Add custom headers if needed
            }
          });
          
          hls.loadSource(sourceUrl);
          hls.attachMedia(mainVideo);
          
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            console.log("HLS manifest parsed, video ready to play");
            setupQualityMenu();
            playVideo();
          });
          
          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS error:', data);
            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  console.error('Fatal network error encountered, trying to recover');
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  console.error('Fatal media error encountered, trying to recover');
                  hls.recoverMediaError();
                  break;
                default:
                  console.error('Fatal error, cannot recover');
                  showError("Stream Error - Cannot Recover");
                  break;
              }
            }
          });
        } else if (mainVideo.canPlayType("application/vnd.apple.mpegurl")) {
          mainVideo.src = sourceUrl;
          mainVideo.addEventListener("loadedmetadata", () => {
            playVideo();
          });
        } else {
          showError("HLS not supported in this browser");
        }
      }

      // Function to setup quality menu
      function setupQualityMenu() {
        if (!hls) return;
        
        const qualityMenu = settings.querySelector("[data-label='quality'] ul");
        const qualityData = hls.levels;
        
        if (qualityData && qualityData.length > 0) {
          qualityMenu.innerHTML = '<li data-quality="auto" class="active">Auto</li>';
          
          qualityData.forEach((level, i) => {
            const height = level.height || level.name || `Level ${i}`;
            qualityMenu.insertAdjacentHTML("beforeend", `<li data-quality="${i}">${height}p</li>`);
          });

          const qualityItems = qualityMenu.querySelectorAll("li");
          qualityItems.forEach((item) => {
            item.addEventListener("click", () => {
              qualityItems.forEach((i) => i.classList.remove("active"));
              item.classList.add("active");

              const quality = item.getAttribute("data-quality");
              if (quality === "auto") {
                hls.currentLevel = -1;
              } else {
                hls.currentLevel = parseInt(quality);
              }
            });
          });
        }
      }

      // Main loading logic
      if (USER) {
        // If ID parameter exists, use the Kick API logic
        const apiUrl = "https://kick.com/api/v2/channels/" + USER;
        
        fetch(apiUrl)
          .then(res => res.json())
          .then(data => {
            if (data.livestream && data.livestream.is_live === true) {
              const source = PROXY + encodeURIComponent(data.playback_url);
              initializeHLS(source);
            } else {
              showError("Stream Offline");
            }
          })
          .catch(err => {
            showError("Error Loading Stream");
          });
      } else if (videoUrl) {
        // If direct URL parameter exists
        initializeHLS(videoUrl);
      } else {
        // Use default stream
        const source = "https://media.onestream.studio/content/hls/live/live_4139402_30h7l45o0/hls.m3u8";
        initializeHLS(source);
      }

      // Initialize captions if available
      if (tracks.length != 0) {
        caption_labels.insertAdjacentHTML("afterbegin", `<li data-track="OFF" class="active">OFF</li>`);
        for (let i = 0; i < tracks.length; i++) {
          let trackLi = `<li data-track="${tracks[i].label}">${tracks[i].label}</li>`;
          caption_labels.insertAdjacentHTML("beforeend", trackLi);
        }
      }
      const caption = captions.querySelectorAll("ul li");

      // Play video function
      function playVideo() {
        hideLoading();
        play_pause.innerHTML = "pause";
        play_pause.title = "pause";
        video_player.classList.add("paused");
        
        const playPromise = mainVideo.play();
        if (playPromise !== undefined) {
          playPromise.then(() => {
            console.log("Video playing successfully");
          }).catch(error => {
            console.error("Error playing video:", error);
            pauseVideo();
          });
        }
      }

      // Pause video function
      function pauseVideo() {
        play_pause.innerHTML = "play_arrow";
        play_pause.title = "play";
        video_player.classList.remove("paused");
        mainVideo.pause();
      }

      // Play/Pause click handler
      play_pause.addEventListener("click", () => {
        if (mainVideo.paused || mainVideo.ended) {
          playVideo();
        } else {
          pauseVideo();
        }
      });

      // Video event listeners
      mainVideo.addEventListener("play", () => {
        play_pause.innerHTML = "pause";
        play_pause.title = "pause";
        video_player.classList.add("paused");
        loader.style.display = "none";
      });

      mainVideo.addEventListener("pause", () => {
        play_pause.innerHTML = "play_arrow";
        play_pause.title = "play";
        video_player.classList.remove("paused");
      });

      mainVideo.addEventListener("waiting", () => {
        loader.style.display = "block";
      });

      mainVideo.addEventListener("playing", () => {
        loader.style.display = "none";
      });

      mainVideo.addEventListener("canplay", () => {
        loader.style.display = "none";
      });

      // fast_rewind video function
      fast_rewind.addEventListener("click", () => {
        mainVideo.currentTime = Math.max(0, mainVideo.currentTime - 10);
      });

      // fast_forward video function
      fast_forward.addEventListener("click", () => {
        mainVideo.currentTime += 10;
      });

      // Load video duration
      mainVideo.addEventListener("loadeddata", (e) => {
        let videoDuration = e.target.duration;
        if (isFinite(videoDuration) && videoDuration > 0) {
          let totalMin = Math.floor(videoDuration / 60);
          let totalSec = Math.floor(videoDuration % 60);
          totalSec < 10 ? (totalSec = "0" + totalSec) : totalSec;
          totalDuration.innerHTML = `${totalMin} : ${totalSec}`;
        } else {
          totalDuration.innerHTML = "LIVE";
        }
      });

      // Current video duration
      mainVideo.addEventListener("timeupdate", (e) => {
        let currentVideoTime = e.target.currentTime;
        let currentMin = Math.floor(currentVideoTime / 60);
        let currentSec = Math.floor(currentVideoTime % 60);
        currentSec < 10 ? (currentSec = "0" + currentSec) : currentSec;
        current.innerHTML = `${currentMin} : ${currentSec}`;

        let videoDuration = e.target.duration;
        if (isFinite(videoDuration) && videoDuration > 0) {
          let progressWidth = (currentVideoTime / videoDuration) * 100 + 0.5;
          progress_Bar.style.width = `${progressWidth}%`;
        }
      });

      // Progress bar interaction
      progressArea.addEventListener("pointerdown", (e) => {
        progressArea.setPointerCapture(e.pointerId);
        setTimelinePosition(e);
        progressArea.addEventListener("pointermove", setTimelinePosition);
        progressArea.addEventListener("pointerup", () => {
          progressArea.removeEventListener("pointermove", setTimelinePosition);
        })
      });

      function setTimelinePosition(e) {
        let videoDuration = mainVideo.duration;
        if (isFinite(videoDuration) && videoDuration > 0) {
          let progressWidthval = progressArea.clientWidth;
          let ClickOffsetX = e.offsetX;
          let newTime = (ClickOffsetX / progressWidthval) * videoDuration;
          mainVideo.currentTime = newTime;

          let progressWidth = (newTime / videoDuration) * 100;
          progress_Bar.style.width = `${progressWidth}%`;

          let currentMin = Math.floor(newTime / 60);
          let currentSec = Math.floor(newTime % 60);
          currentSec < 10 ? (currentSec = "0" + currentSec) : currentSec;
          current.innerHTML = `${currentMin} : ${currentSec}`;
        }
      }

      // Volume controls
      function changeVolume() {
        mainVideo.volume = volume_range.value / 100;
        if (volume_range.value == 0) {
          volume.innerHTML = "volume_off";
        } else if (volume_range.value < 40) {
          volume.innerHTML = "volume_down";
        } else {
          volume.innerHTML = "volume_up";
        }
      }

      function muteVolume() {
        if (volume_range.value == 0) {
          volume_range.value = 80;
          mainVideo.volume = 0.8;
          volume.innerHTML = "volume_up";
        } else {
          volume_range.value = 0;
          mainVideo.volume = 0;
          volume.innerHTML = "volume_off";
        }
      }

      volume_range.addEventListener("change", changeVolume);
      volume.addEventListener("click", muteVolume);

      // Auto play
      auto_play.addEventListener("click", () => {
        auto_play.classList.toggle("active");
        if (auto_play.classList.contains("active")) {
          auto_play.title = "Autoplay is on";
        } else {
          auto_play.title = "Autoplay is off";
        }
      });

      // Picture in picture
      picture_in_picutre.addEventListener("click", () => {
        if (document.pictureInPictureElement) {
          document.exitPictureInPicture();
        } else {
          mainVideo.requestPictureInPicture();
        }
      });

      // Full screen function
      fullscreen.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          video_player.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen: ${err.message}`);
          });
          fullscreen.innerHTML = "fullscreen_exit";
        } else {
          document.exitFullscreen();
          fullscreen.innerHTML = "fullscreen";
        }
      });

      // Settings and captions
      settingsBtn.addEventListener("click", () => {
        settings.classList.toggle("active");
        settingsBtn.classList.toggle("active");
        if (captionsBtn.classList.contains("active") || captions.classList.contains("active")) {
          captions.classList.remove("active");
          captionsBtn.classList.remove("active");
        }
      });
      
      captionsBtn.addEventListener("click", () => {
        captions.classList.toggle("active");
        captionsBtn.classList.toggle("active");
        if (settingsBtn.classList.contains("active") || settings.classList.contains("active")) {
          settings.classList.remove("active");
          settingsBtn.classList.remove("active");
        }
      });

      // Playback Rate
      playback.forEach((event) => {
        event.addEventListener("click", () => {
          removeActiveClasses(playback);
          event.classList.add("active");
          let speed = event.getAttribute("data-speed");
          mainVideo.playbackRate = speed;
        });
      });

      // Captions
      caption.forEach((event) => {
        event.addEventListener("click", () => {
          removeActiveClasses(caption);
          event.classList.add("active");
          changeCaption(event);
          caption_text.innerHTML = "";
        });
      });

      let track = mainVideo.textTracks;
      function changeCaption(lable) {
        let trackLable = lable.getAttribute("data-track");
        for (let i = 0; i < track.length; i++) {
          track[i].mode = "disabled";
          if (track[i].label == trackLable) {
            track[i].mode = "showing";
          }
        }
      }

      // Hide controls when mouse is not moving
      let mouseMovementTimer;
      video_player.addEventListener("mousemove", () => {
        controls.classList.add("active");
        clearTimeout(mouseMovementTimer);
        mouseMovementTimer = setTimeout(() => {
          if (!mainVideo.paused) {
            controls.classList.remove("active");
          }
        }, 3000);
      });

      video_player.addEventListener("mouseenter", () => {
        controls.classList.add("active");
      });

      video_player.addEventListener("mouseleave", () => {
        if (!mainVideo.paused) {
          controls.classList.remove("active");
        }
      });

      function removeActiveClasses(elements) {
        elements.forEach((element) => {
          element.classList.remove("active");
        });
      }

      // Track captions
      let trackElements = mainVideo.textTracks;
      for (let i = 0; i < trackElements.length; i++) {
        trackElements[i].addEventListener("cuechange", () => {
          if (trackElements[i].mode === "showing") {
            if (trackElements[i].activeCues[0]) {
              let span = `<span><mark>${trackElements[i].activeCues[0].text}</mark></span>`;
              caption_text.innerHTML = span;
            } else {
              caption_text.innerHTML = "";
            }
          }
        });
      }

      // Handle settings navigation (Speed / Quality)
      settingHome.forEach((item) => {
        item.addEventListener("click", () => {
          const label = item.getAttribute("data-label");
          settings.querySelectorAll("[data-label]").forEach((section) => {
            section.hidden = section.getAttribute("data-label") !== label;
          });
        });
      });

      // Handle back arrow inside submenus
      settings.querySelectorAll(".back_arrow").forEach((back) => {
        back.addEventListener("click", () => {
          settings.querySelectorAll("[data-label]").forEach((section) => {
            section.hidden = section.getAttribute("data-label") !== "settingHome";
          });
        });
      });

      // Frame Capture Elements
      const frameCaptureBtn = video_player.querySelector(".frame-capture");
      const capturedFrame = video_player.querySelector(".captured-frame");
      const capturedFrameImg = capturedFrame.querySelector("img");
      const closeFrameBtn = capturedFrame.querySelector(".close-frame");

      // Frame Capture Functionality - FIXED
      frameCaptureBtn.addEventListener("click", captureFrame);

      function captureFrame() {
        try {
          // Create a temporary canvas
          const canvas = document.createElement('canvas');
          canvas.width = mainVideo.videoWidth;
          canvas.height = mainVideo.videoHeight;
          
          const ctx = canvas.getContext('2d');
          
          // Draw the current video frame
          ctx.drawImage(mainVideo, 0, 0, canvas.width, canvas.height);
          
          // Convert to data URL
          const imageData = canvas.toDataURL('image/png');
          
          // Update the preview image
          capturedFrameImg.src = imageData;
          capturedFrame.classList.add('active');
          
          // Create download link
          const link = document.createElement('a');
          link.href = imageData;
          link.download = `frame_capture_${Date.now()}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          console.log('Frame captured successfully');
        } catch (error) {
          console.error('Error capturing frame:', error);
          alert('Failed to capture frame. Make sure the video is playing and try again.');
        }
      }

      // Close frame preview
      closeFrameBtn.addEventListener("click", () => {
        capturedFrame.classList.remove("active");
      });

      // Close frame when clicking outside
      video_player.addEventListener("click", (e) => {
        if (!capturedFrame.contains(e.target) && e.target !== frameCaptureBtn) {
          capturedFrame.classList.remove("active");
        }
      });

    });
  </script>
</body>
</html>
